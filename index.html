<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>DIBBA RADAR</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Dibba Radar">
<meta name="theme-color" content="#141414">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="152x152" href="assets/icon-152.png">
<link rel="apple-touch-icon" sizes="167x167" href="assets/icon-167.png">
<link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="assets/icon-192.png">
<link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)" href="assets/splash-1170x2532.png">
<link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)" href="assets/splash-1179x2556.png">
<link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)" href="assets/splash-1290x2796.png">
<link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/radar.css">
</head>
<body>

<!-- Full-screen map -->
<div id="map"></div>

<!-- Top bar: branding + controls -->
<div id="topBar" class="top-bar">
    <div class="top-brand">Dibba <span class="top-brand-accent">Radar</span></div>
    <button id="tripHistoryBtn" class="top-btn" onclick="toggleTripHistory()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    </button>
    <button id="legendBtn" class="top-btn" onclick="toggleLegend()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
    </button>
    <button id="settingsBtn" class="top-btn" onclick="toggleSettings()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
    </button>
</div>

<!-- Search bar (standalone, below top bar) -->
<div id="searchBar" class="search-bar">
    <div id="searchWrap" class="search-wrap">
        <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
        <input id="searchInput" class="search-input" type="text" placeholder="Where to?" autocomplete="off">
        <button id="clearSearch" class="search-clear" onclick="clearSearch()" style="display:none">&times;</button>
    </div>
    <!-- Route info (appears after routing) -->
    <div id="routeInfo" class="route-info" style="display:none">
        <div class="ri-stats">
            <div class="ri-stat"><span class="ri-val" id="riDist">--</span><span class="ri-label">km</span></div>
            <div class="ri-stat"><span class="ri-val" id="riTime">--</span><span class="ri-label">min</span></div>
            <div class="ri-stat"><span class="ri-val" id="riCams">--</span><span class="ri-label">cams</span></div>
        </div>
        <button class="ri-go" id="goBtn" onclick="startNavigation()">GO</button>
    </div>
</div>

<!-- Search results dropdown -->
<div id="searchResults" class="search-results"></div>

<!-- Legend overlay -->
<div id="legend" class="legend" style="display:none">
    <div class="legend-title">CAMERA DENSITY</div>
    <div class="legend-row"><span class="legend-line" style="background:#ff1744"></span> Heavy (&lt;1 km gap)</div>
    <div class="legend-row"><span class="legend-line" style="background:#ff6d00"></span> Moderate (1-2.5 km)</div>
    <div class="legend-row"><span class="legend-line" style="background:#ffd600"></span> Light (2.5-5 km)</div>
    <div class="legend-row"><span class="legend-line" style="background:#00e676"></span> Clear (&gt;5 km)</div>
    <div class="legend-sep"></div>
    <div class="legend-title">CAMERAS</div>
    <div class="legend-row"><span class="legend-dot" style="background:#ff1744"></span> 120+ km/h</div>
    <div class="legend-row"><span class="legend-dot" style="background:#ff6d00"></span> 80-119 km/h</div>
    <div class="legend-row"><span class="legend-dot" style="background:#ffd600"></span> &lt;80 km/h</div>
    <div class="legend-row"><span class="legend-dot" style="background:#78909c"></span> Unknown limit</div>
</div>

<!-- Speed widget (map view, Waze-style circle) -->
<div id="speedOverlay" class="speed-widget">
    <div id="speedValue" class="speed-val">--</div>
    <div class="speed-unit">km/h</div>
    <div id="speedLimitBadge" class="speed-limit-badge">--</div>
</div>

<!-- Camera proximity alert -->
<div id="alertBanner" class="alert-banner">
    <div id="alertText" class="alert-text"></div>
    <div id="alertLimit" class="alert-limit"></div>
</div>

<!-- Drive button -->
<button id="startDriveBtn" class="drive-btn" onclick="startDrive()">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
    DRIVE
</button>
<button id="stopDriveBtn" class="stop-btn" onclick="stopDrive()">STOP</button>
<button id="centerBtn" class="center-btn" onclick="centerOnMe()">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg>
</button>

<!-- Speed flash overlays (UAE +20 margin) -->
<div id="flashRed" class="flash-overlay flash-red">
    <div class="flash-text">SLOW DOWN</div>
    <div class="flash-sub" id="flashRedSub"></div>
</div>
<div id="flashGreen" class="flash-overlay flash-green">
    <div class="flash-text flash-text-ok">CLEAR</div>
</div>
<!-- Legacy slow down (kept for module compat) -->
<div id="slowDownOverlay" class="slow-down-overlay" style="display:none"></div>

<!-- Off route badge -->
<div id="offRouteBadge" class="off-route-badge">OFF ROUTE</div>

<!-- HUD (driving overlay on top of map) -->
<div id="hudContainer" class="hud" onclick="hudTap(event)">
    <div class="hud-top">
        <div id="hudTurn" class="hud-turn" style="display:none">
            <div id="hudTurnIcon" class="hud-turn-icon"></div>
            <div class="hud-turn-info">
                <div id="hudTurnDist" class="hud-turn-dist">--</div>
                <div id="hudTurnName" class="hud-turn-name"></div>
            </div>
        </div>
        <div id="hudCamLabel" class="hud-label">CAMERA IN</div>
        <div id="hudCamDist" class="hud-dist">--</div>
        <div class="hud-bar"><div id="hudCamBar" class="hud-bar-fill"></div></div>
    </div>
    <div class="hud-center">
        <div class="hud-speed-wrap">
            <div id="hudSpeed" class="hud-speed hud-speed-ok">--</div>
            <div id="hudLimitBadge" class="hud-limit-badge">--</div>
        </div>
        <div id="hudSpeedUnit" class="hud-unit">km/h</div>
    </div>
    <!-- Average speed zone indicator -->
    <div id="avgSpeedZone" class="avg-zone" style="display:none">
        <div class="avg-zone-label">AVG SPEED ZONE</div>
        <div class="avg-zone-info">
            <span id="avgZoneLimit" class="avg-zone-limit">--</span>
            <span class="avg-zone-unit">km/h</span>
        </div>
        <div class="avg-zone-bar">
            <div id="avgZoneProgress" class="avg-zone-bar-fill"></div>
        </div>
        <div class="avg-zone-stats">
            <span id="avgZoneLength">--</span> km zone
            <span id="avgZoneAvgSpeed" class="avg-zone-avg">AVG: --</span>
        </div>
    </div>
    <div class="hud-bottom">
        <div id="hudEta" class="hud-eta" style="display:none">
            <span id="hudEtaTime" class="hud-eta-time">--</span>
            <span class="hud-eta-label">ETA</span>
        </div>
        <canvas id="speedTrendCanvas" class="hud-trend" width="300" height="50"></canvas>
        <div id="hudOffRoute" class="hud-off-route">OFF ROUTE</div>
    </div>
    <button class="hud-btn hud-btn-map" onclick="hudToMap(event)">MAP</button>
    <button class="hud-btn hud-btn-stop" onclick="hudStop(event)">STOP</button>
</div>

<!-- Settings panel -->
<div id="settingsPanel" class="settings-panel" style="display:none">
    <div class="settings-header">
        <span>SETTINGS</span>
        <button onclick="toggleSettings()">x</button>
    </div>
    <div class="settings-body">
        <div class="setting-row">
            <span>Units</span>
            <div class="setting-pills">
                <button class="pill active" id="unitsKmh" onclick="setUnits('kmh')">km/h</button>
                <button class="pill" id="unitsMph" onclick="setUnits('mph')">mph</button>
            </div>
        </div>
        <div class="setting-row">
            <span>Alert Distance</span>
            <div class="setting-pills">
                <button class="pill" id="alertShort" onclick="setAlertDistance('short')">Short</button>
                <button class="pill active" id="alertMedium" onclick="setAlertDistance('medium')">Medium</button>
                <button class="pill" id="alertLong" onclick="setAlertDistance('long')">Long</button>
            </div>
        </div>
        <div class="setting-row">
            <span>Audio</span>
            <label class="switch"><input type="checkbox" id="audioToggle" checked><span class="slider"></span></label>
        </div>
        <div class="setting-row">
            <span>Volume</span>
            <div class="setting-slider">
                <input type="range" id="volumeSlider" min="0" max="100" value="80" class="range-slider" oninput="setVolume(this.value)">
                <span id="volumeVal" class="range-val">80%</span>
            </div>
        </div>
        <div class="setting-row">
            <span>Theme</span>
            <div class="setting-pills">
                <button class="pill active" id="themeAuto" onclick="setTheme('auto')">Auto</button>
                <button class="pill" id="themeDark" onclick="setTheme('dark')">Dark</button>
                <button class="pill" id="themeLight" onclick="setTheme('light')">Light</button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden elements needed by modules -->
<div id="panel" style="display:none"></div>
<div id="routePicker" style="display:none"></div>
<div id="loadingOverlay" class="loading-overlay" style="display:none"><div id="loadingText" class="loading-text"></div></div>
<div id="overlay" style="display:none"></div>
<div id="speedPicker" style="display:none"></div>
<div id="historyPanel" style="display:none"></div>
<div id="sharePanel" style="display:none"></div>

<!-- Onboarding (first visit only) -->
<div id="onboarding" class="onboarding" style="display:none">
    <div class="onboarding-card">
        <div class="onboarding-title">Dibba <span style="font-weight:400">Radar</span></div>
        <div class="onboarding-sub">Speed camera companion for UAE highways</div>
        <div class="onboarding-items">
            <div class="onboarding-item">
                <span class="onboarding-dot" style="background:#ff1744"></span>
                <span>Red dots = cameras enforcing 120+ km/h</span>
            </div>
            <div class="onboarding-item">
                <span class="onboarding-dot" style="background:#ff6d00"></span>
                <span>Orange dots = 80-119 km/h cameras</span>
            </div>
            <div class="onboarding-item">
                <span class="onboarding-dot" style="background:#ffd600"></span>
                <span>Yellow dots = under 80 km/h zones</span>
            </div>
            <div class="onboarding-item">
                <span class="onboarding-dot" style="background:#78909c"></span>
                <span>Grey dots = unknown speed limit</span>
            </div>
            <div class="onboarding-sep"></div>
            <div class="onboarding-item">
                <span class="onboarding-line" style="background:#ff1744"></span>
                <span>Red roads = heavy camera coverage</span>
            </div>
            <div class="onboarding-item">
                <span class="onboarding-line" style="background:#00e676"></span>
                <span>Green roads = clear stretches (5+ km gap)</span>
            </div>
            <div class="onboarding-sep"></div>
            <div class="onboarding-item">
                <span style="font-size:14px;width:24px;text-align:center">+20</span>
                <span>UAE fine threshold: limit + 20 km/h</span>
            </div>
        </div>
        <button class="onboarding-btn" onclick="dismissOnboarding()">GOT IT</button>
    </div>
</div>

<!-- Report picker (long-press on map) -->
<div id="reportPicker" class="report-picker" style="display:none">
    <div class="report-title">REPORT</div>
    <div class="report-options">
        <button class="report-opt" onclick="submitReport('radar')">
            <span class="report-dot" style="background:#ff1744"></span>
            Mobile Radar
        </button>
        <button class="report-opt" onclick="submitReport('police')">
            <span class="report-dot" style="background:#2196f3"></span>
            Police
        </button>
        <button class="report-opt" onclick="submitReport('accident')">
            <span class="report-dot" style="background:#ff9800"></span>
            Accident
        </button>
        <button class="report-opt" onclick="submitReport('hazard')">
            <span class="report-dot" style="background:#ffd600"></span>
            Hazard
        </button>
    </div>
    <button class="report-cancel" onclick="cancelReport()">CANCEL</button>
</div>

<!-- Trip history panel -->
<div id="tripHistoryPanel" class="trip-history-panel" style="display:none">
    <div class="trip-history-header">
        <span>TRIP HISTORY</span>
        <button onclick="closeTripHistory()">x</button>
    </div>
    <div id="tripHistoryList" class="trip-history-list">
        <div class="trip-history-empty">No trips recorded yet</div>
    </div>
</div>

<!-- Trip summary toast -->
<div id="tripToast" class="trip-toast" style="display:none">
    <span id="tripToastText"></span>
</div>

<!-- JS modules -->
<script src="js/utils.js"></script>
<script src="js/storage.js"></script>
<script src="js/settings.js"></script>
<script src="js/theme.js"></script>
<script src="js/audio.js"></script>
<script src="js/cameras.js"></script>
<script src="js/pins.js"></script>
<script src="js/waze.js"></script>
<script src="js/map.js"></script>
<script src="js/search.js"></script>
<script src="js/routing.js"></script>
<script src="js/gps.js"></script>
<script src="js/alerts.js"></script>
<script src="js/speed-limit.js"></script>
<script src="js/radar-map.js"></script>
<script src="js/hud.js"></script>
<script src="js/speed-trend.js"></script>
<script src="js/avg-speed-zones.js"></script>
<script src="js/history.js"></script>
<script src="js/share.js"></script>
<script src="js/route-picker.js"></script>
<script src="js/trip-log.js"></script>
<script src="js/reports.js"></script>
<script src="js/app.js"></script>
</body>
</html>
